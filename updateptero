#!/usr/bin/env bash
set -e

# ===========================
#   Pterodactyl Panel Updater
# ===========================

clear
echo -e "\e[1;36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\e[0m"
echo -e "   ğŸ”„  PTERODACTYL PANEL UPDATE UTILITY  ğŸ”„"
echo -e "\e[1;36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\e[0m"
echo ""

echo -e "ğŸš€ Starting update process for Pterodactyl Panel..."

# Go to panel directory
cd /var/www/pterodactyl || { echo -e "âŒ \e[1;31mPanel directory not found!\e[0m"; exit 1; }

# Maintenance mode
echo -e "âš™ï¸  Enabling maintenance mode..."
php artisan down

# Download latest release
echo -e "â¬‡ï¸  Fetching latest panel release..."
curl -L https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz | tar -xzv

# Permissions
echo -e "ğŸ”‘ Adjusting file permissions..."
chmod -R 755 storage/* bootstrap/cache

# Composer install
echo -e "ğŸ“¦ Installing PHP dependencies (Composer)..."
composer install --no-dev --optimize-autoloader

# Clear caches
echo -e "ğŸ§¹ Clearing Laravel caches..."
php artisan view:clear
php artisan config:clear

# Migrations
echo -e "ğŸ“‚ Running database migrations..."
php artisan migrate --seed --force

# Ownership
echo -e "ğŸ‘¤ Resetting ownership to www-data..."
chown -R www-data:www-data /var/www/pterodactyl/*

# Restart queue workers
echo -e "â™»ï¸  Restarting queue workers..."
php artisan queue:restart

# Back online
echo -e "âœ… Bringing panel back online..."
php artisan up

# Done
echo ""
echo -e "\e[1;32mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\e[0m"
echo -e " ğŸ‰  Update completed successfully! Enjoy ğŸš€"
echo -e "\e[1;32mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\e[0m"
