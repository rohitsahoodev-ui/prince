#!/bin/bash
# ====================================================
#        üåü BLUEPRINT FRAMEWORK INSTALLER üåü
#        Pterodactyl Panel + Blueprint Auto Setup
# ====================================================

set -e

# ================= COLORS =================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# ================= VARIABLES =================
PTERO_DIR="/var/www/pterodactyl"

# ================= CHECK ROOT =================
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}‚ùå Please run this script as ROOT${NC}"
   exit 1
fi

# ================= HEADER =================
clear
echo -e "${MAGENTA}${BOLD}"
cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     üü¶ BLUEPRINT FRAMEWORK INSTALLER üü¶     ‚ïë
‚ïë     Pterodactyl Panel Auto Setup             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
echo -e "${NC}"

# ================= PANEL UPDATE =================
echo -e "${CYAN}‚ö° Updating Pterodactyl Panel...${NC}"
cd "$PTERO_DIR" || { echo -e "${RED}‚ùå Pterodactyl not found${NC}"; exit 1; }

php artisan down || true

curl -L https://github.com/pterodactyl/panel/releases/download/v1.11.11/panel.tar.gz | tar -xzv
chmod -R 755 storage/* bootstrap/cache

composer install --no-dev --optimize-autoloader
php artisan view:clear
php artisan config:clear
php artisan migrate --seed --force
chown -R www-data:www-data /var/www/pterodactyl/*
php artisan queue:restart
php artisan up

echo -e "${GREEN}‚úÖ Panel Updated Successfully${NC}"

# ================= DEPENDENCIES =================
echo -e "${CYAN}üîß Installing Dependencies...${NC}"
apt update
apt install -y ca-certificates curl gnupg unzip zip git software-properties-common

# ================= NODEJS 20 =================
echo -e "${CYAN}‚¨áÔ∏è Installing Node.js 20...${NC}"
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

# ================= YARN (PROPER WAY) =================
echo -e "${CYAN}üì¶ Installing Yarn...${NC}"
npm install -g yarn

# ================= VERIFY =================
echo -e "${CYAN}üîç Verifying Node & Yarn...${NC}"
node -v || { echo -e "${RED}‚ùå Node failed${NC}"; exit 1; }
yarn -v || { echo -e "${RED}‚ùå Yarn not found in PATH${NC}"; exit 1; }

echo -e "${GREEN}‚úÖ Node & Yarn Installed Successfully${NC}"

# ================= DOWNLOAD BLUEPRINT =================
echo -e "${CYAN}‚¨áÔ∏è Downloading Blueprint Framework...${NC}"
cd "$PTERO_DIR"

LATEST_URL=$(curl -s https://api.github.com/repos/BlueprintFramework/framework/releases/latest \
| grep browser_download_url \
| grep release.zip \
| cut -d '"' -f 4)

wget -O blueprint.zip "$LATEST_URL"

# ================= EXTRACT =================
echo -e "${CYAN}üì¶ Extracting Blueprint...${NC}"
unzip -o blueprint.zip
rm -f blueprint.zip

# ================= INSTALL NODE MODULES =================
echo -e "${CYAN}üì¶ Installing Node Modules...${NC}"
yarn install

# ================= CONFIG =================
echo -e "${CYAN}‚öôÔ∏è Creating .blueprintrc...${NC}"
cat << EOF > .blueprintrc
WEBUSER="www-data";
OWNERSHIP="www-data:www-data";
USERSHELL="/bin/bash";
EOF

chmod +x blueprint.sh

# ================= RUN BLUEPRINT =================
echo -e "${CYAN}üöÄ Running Blueprint Installer...${NC}"
bash blueprint.sh

# ================= DONE =================
echo -e "${GREEN}${BOLD}üéâ Blueprint Installed Successfully!${NC}"
echo -e "${YELLOW}üëâ You can now install addons using Blueprint CLI${NC}"
