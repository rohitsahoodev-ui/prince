#!/bin/bash
set -e

# ================================
#   Pterodactyl Uninstaller Tool
# ================================

# -------- Functions --------

cleanup_nginx() {
    echo -e "ğŸ§¹ \e[1;33mRemoving Nginx configuration for Pterodactyl...\e[0m"
    if [[ -f "/etc/nginx/sites-enabled/pterodactyl.conf" ]]; then
        sudo rm -f /etc/nginx/sites-enabled/pterodactyl.conf
    fi
    if [[ -f "/etc/nginx/sites-available/pterodactyl.conf" ]]; then
        sudo rm -f /etc/nginx/sites-available/pterodactyl.conf
    fi
    if [[ -f "/etc/nginx/conf.d/pterodactyl.conf" ]]; then
        sudo rm -f /etc/nginx/conf.d/pterodactyl.conf
    fi

    if command -v nginx >/dev/null 2>&1; then
        sudo systemctl restart nginx
        echo -e "âœ… \e[1;32mNginx reloaded.\e[0m"
    fi
}

uninstall_panel() {
    echo -e "ğŸ›‘ \e[1;31mStopping Panel service...\e[0m"
    sudo systemctl stop pteroq.service || true
    sudo systemctl disable pteroq.service || true
    sudo rm -f /etc/systemd/system/pteroq.service
    sudo systemctl daemon-reload

    echo -e "ğŸ—‘ï¸  \e[1;33mRemoving Panel cronjob...\e[0m"
    sudo crontab -l | grep -v 'php /var/www/pterodactyl/artisan schedule:run' | sudo crontab - || true

    echo -e "ğŸ—‘ï¸  \e[1;33mRemoving Panel files...\e[0m"
    sudo rm -rf /var/www/pterodactyl

    echo -e "ğŸ’¾ \e[1;33mDropping Panel MySQL database and user...\e[0m"
    sudo mysql -u root -e "DROP DATABASE IF EXISTS panel;"
    sudo mysql -u root -e "DROP USER IF EXISTS 'pterodactyl'@'127.0.0.1';"
    sudo mysql -u root -e "FLUSH PRIVILEGES;"

    cleanup_nginx

    echo -e "âœ… \e[1;32mPanel uninstalled successfully!\e[0m"
}

uninstall_wings() {
    echo -e "ğŸ›‘ \e[1;31mStopping Wings service...\e[0m"
    sudo systemctl stop wings.service || true
    sudo systemctl disable wings.service || true
    sudo rm -f /etc/systemd/system/wings.service
    sudo systemctl daemon-reload

    echo -e "ğŸ—‘ï¸  \e[1;33mRemoving Wings files...\e[0m"
    sudo rm -rf /etc/pterodactyl
    sudo rm -rf /var/lib/pterodactyl
    sudo rm -rf /var/log/pterodactyl

    echo -e "âœ… \e[1;32mWings uninstalled successfully!\e[0m"
}

uninstall_both() {
    uninstall_panel
    uninstall_wings
    echo -e "âœ… \e[1;32mPanel and Wings fully uninstalled!\e[0m"
}

# -------- Menu --------

while true; do
    clear
    echo -e "\e[1;36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\e[0m"
    echo -e "   ğŸ—‘ï¸  PTERODACTYL UNINSTALLER MENU"
    echo -e "\e[1;36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\e[0m"
    echo ""
    echo "1) ğŸ—‘ï¸  Uninstall Panel"
    echo "2) ğŸ—‘ï¸  Uninstall Wings"
    echo "3) ğŸ—‘ï¸  Uninstall Panel + Wings"
    echo "0) âŒ Exit"
    echo "-------------------------------------"
    read -p "ğŸ‘‰ Choose an option: " choice

    case $choice in
        1) uninstall_panel ;;
        2) uninstall_wings ;;
        3) uninstall_both ;;
        0) echo -e "ğŸ‘‹ Exiting uninstaller..."; exit 0 ;;
        *) echo -e "âŒ \e[1;31mInvalid option!\e[0m"; read -p "Press Enter to continue..." ;;
    esac

    read -p "ğŸ” Press Enter to return to menu..."
done
